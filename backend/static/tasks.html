<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pysaundary | Tasks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{ --mint-bg:#e0ffe9; --mint-accent:#2e8b57; --mint-border:#b6f1c7; }
    body{ background:#fff; min-height:100vh; display:grid; grid-template-rows:auto 1fr; }
    .brand{ color:var(--mint-accent); font-weight:600; letter-spacing:.5px; }
    .card-mint{ background:var(--mint-bg); border:1px solid var(--mint-border); border-radius:14px; }
    .form-control{ border-radius:10px; border-color:var(--mint-border); }
    .badge-done{ background:#52c279; }
    .badge-pending{ background:#adb5bd; }
    .toast-mint{ --bs-toast-bg:#d5f9dd; --bs-toast-header-bg:#c0f3cc; border-color:var(--mint-border); }
    .top-right{ position:fixed; right:1rem; top:1rem; z-index:1080; }
  </style>
</head>
<body>
  <nav class="navbar bg-white">
    <div class="container d-flex align-items-center">
      <span class="navbar-brand mb-0 h1 brand">Pysaundary</span>
      <div class="ms-auto d-flex gap-2">
        <input id="filter-priority" type="number" min="0" class="form-control form-control-sm" placeholder="priority"/>
        <select id="filter-done" class="form-select form-select-sm">
          <option value="">all</option>
          <option value="true">done</option>
          <option value="false">pending</option>
        </select>
        <button id="logout-btn" class="btn btn-outline-success btn-sm">Logout</button>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="card card-mint shadow-sm mb-4">
      <div class="card-header bg-transparent fw-semibold">Create / Edit Task</div>
      <div class="card-body">
        <form id="task-form" class="row g-3">
          <input type="hidden" id="task-id"/>
          <div class="col-md-6">
            <label class="form-label">Title</label>
            <input id="task-title" class="form-control" required/>
          </div>
          <div class="col-md-6">
            <label class="form-label">Priority</label>
            <input id="task-priority" type="number" min="0" value="1" class="form-control"/>
          </div>
          <div class="col-12">
            <label class="form-label">Description</label>
            <textarea id="task-desc" rows="2" class="form-control"></textarea>
          </div>
          <div class="col-12">
            <div class="form-check">
              <input id="task-done" class="form-check-input" type="checkbox"/>
              <label class="form-check-label" for="task-done">Done</label>
            </div>
          </div>
          <div class="col-12">
            <button class="btn btn-success" type="submit">Save</button>
            <button id="reset-btn" class="btn btn-secondary" type="button">Reset</button>
          </div>
        </form>
        <div id="form-msg" class="mt-2 text-danger small"></div>
      </div>
    </div>

    <div class="card card-mint shadow-sm">
      <div class="card-header bg-transparent d-flex align-items-center gap-2">
        <span class="fw-semibold">Tasks</span>
        <div class="ms-auto">
          <input id="limit" type="number" min="1" max="100" value="20" class="form-control form-control-sm d-inline-block" style="width:80px"/>
          <input id="offset" type="number" min="0" value="0" class="form-control form-control-sm d-inline-block" style="width:80px"/>
          <button id="reload" class="btn btn-outline-success btn-sm">Reload</button>
        </div>
      </div>
      <div class="card-body">
        <div id="list-msg" class="text-danger small mb-2"></div>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Title</th>
                <th>Priority</th>
                <th>Done</th>
                <th>Description</th>
                <th style="width:160px;">Actions</th>
              </tr>
            </thead>
            <tbody id="tasks-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <div class="top-right">
    <div id="toast" class="toast align-items-center toast-mint" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Status</strong>
        <small>now</small>
        <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toast-body">Success</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // API + auth helpers
    const API_BASE = 'http://0.0.0.0:8000';
    function setToken(t){ localStorage.setItem('token', t); }
    function getToken(){ return localStorage.getItem('token'); }
    function clearToken(){ localStorage.removeItem('token'); }
    async function apiFetch(path, options = {}) {
      const token = getToken();
      const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(`${API_BASE}${path}`, { ...options, headers });
      let data = null;
      try { data = await res.json(); } catch {}
      if (!res.ok || (data && data.status === false)) {
        const msg = (data && (data.message || data.detail)) || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data ?? {};
    }

    // guard
    if (!getToken()) { location.href = '/'; }

    const tbody = document.getElementById('tasks-tbody');
    const form = document.getElementById('task-form');
    const resetBtn = document.getElementById('reset-btn');
    const formMsg = document.getElementById('form-msg');
    const listMsg = document.getElementById('list-msg');
    const logoutBtn = document.getElementById('logout-btn');

    const limitEl = document.getElementById('limit');
    const offsetEl = document.getElementById('offset');
    const reloadBtn = document.getElementById('reload');
    const fp = document.getElementById('filter-priority');
    const fd = document.getElementById('filter-done');

    logoutBtn.addEventListener('click', () => { clearToken(); location.href = '/'; });

    function readForm() {
      return {
        id: document.getElementById('task-id').value || null,
        title: document.getElementById('task-title').value.trim(),
        description: document.getElementById('task-desc').value.trim(),
        priority: Number(document.getElementById('task-priority').value || 0),
        is_done: document.getElementById('task-done').checked
      };
    }
    function fillForm(task) {
      const p = task.payload || {};
      document.getElementById('task-id').value = task.id || '';
      document.getElementById('task-title').value = p.title || '';
      document.getElementById('task-desc').value = p.description || '';
      document.getElementById('task-priority').value = p.priority ?? 1;
      document.getElementById('task-done').checked = !!p.is_done;
    }
    function resetForm() {
      document.getElementById('task-id').value = '';
      document.getElementById('task-title').value = '';
      document.getElementById('task-desc').value = '';
      document.getElementById('task-priority').value = 1;
      document.getElementById('task-done').checked = false;
      formMsg.textContent = '';
    }
    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function badge(v){ return v ? 'success' : 'secondary'; }

    async function loadTasks() {
      listMsg.textContent = '';
      tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
      const params = new URLSearchParams();
      const limit = Number(limitEl.value || 20);
      const offset = Number(offsetEl.value || 0);
      params.set('limit', String(limit));
      params.set('offset', String(offset));
      if (fp.value !== '') params.set('priority', fp.value);
      if (fd.value !== '') params.set('is_done', fd.value);

      try {
        const list = await apiFetch(`/tasks/?${params.toString()}`, { method: 'GET' });
        tbody.innerHTML = '';
        list.forEach(addRow);
      } catch (e) {
        tbody.innerHTML = '';
        listMsg.textContent = e.message || 'Failed to load tasks';
      }
    }

    function addRow(task) {
      const p = task.payload || {};
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(p.title)}</td>
        <td>${escapeHtml(p.priority)}</td>
        <td><span class="badge text-bg-${badge(p.is_done)}">${p.is_done ? 'Yes' : 'No'}</span></td>
        <td>${escapeHtml(p.description)}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary me-2">Edit</button>
          <button class="btn btn-sm btn-outline-danger">Delete</button>
        </td>
      `;
      const [editBtn, delBtn] = tr.querySelectorAll('button');
      editBtn.addEventListener('click', () => fillForm(task));
      delBtn.addEventListener('click', async () => {
        if (!confirm('Delete this task?')) return;
        try {
          await apiFetch(`/tasks/${task.id}`, { method: 'DELETE' });
          await loadTasks();
        } catch (e) {
          listMsg.textContent = e.message || 'Delete failed';
        }
      });
      tbody.appendChild(tr);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const { id, title, description, priority, is_done } = readForm();
      if (!title) { formMsg.textContent = 'Title is required'; return; }
      formMsg.textContent = '';
      try {
        if (id) {
          await apiFetch(`/tasks/${id}`, { method: 'PATCH', body: JSON.stringify({ title, description, priority, is_done }) });
        } else {
          await apiFetch('/tasks/', { method: 'POST', body: JSON.stringify({ title, description, priority, is_done }) });
        }
        resetForm();
        await loadTasks();
      } catch (e) {
        formMsg.textContent = e.message || 'Save failed';
      }
    });

    reloadBtn.addEventListener('click', () => loadTasks());
    fp.addEventListener('change', () => loadTasks());
    fd.addEventListener('change', () => loadTasks());

    resetForm();
    loadTasks();
  </script>
</body>
</html>
